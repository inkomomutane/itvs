services:
  php:
    image: localhost:5000/food:latest
    environment:
      PHP_OPCACHE_ENABLE: "1"
      AUTORUN_ENABLED: "true" # ðŸ‘ˆ Remove this line if you don't want Laravel Automations
      HEALTHCHECK_PATH: "/up" # Use Laravel's built-in health route
      SSL_MODE: full
      LOG_OUTPUT_LEVEL: debug
    networks:
      - traefik_public
      - shared_mysql_database
    volumes:
      - "storage_private:/var/www/html/storage/app/private/"
      - "./backup:/var/www/html/storage/app/public/"
      - "storage_sessions:/var/www/html/storage/framework/sessions"
      - "storage_logs:/var/www/html/storage/logs"
      - "storage_svg:/var/www/html/storage/app/svg"
      - "./.env:/var/www/html/.env"
    deploy:
      replicas: 3
      update_config:
        failure_action: rollback
        parallelism: 1
        delay: 5s
        order: start-first
      rollback_config:
        parallelism: 1
        order: stop-first
      restart_policy:
        condition: any
        delay: 10s
        max_attempts: 3
        window: 120s
      labels:
        - "traefik.enable=true"
        # HTTPS Router (namespaced)
        - "traefik.http.routers.food_php.rule=Host(`cmdondorefeitorio.mooo.com`)"
        - "traefik.http.routers.food_php.entrypoints=websecure"
        - "traefik.http.routers.food_php.tls=true"
        - "traefik.http.routers.food_php.tls.certresolver=le"
        - "traefik.http.services.food_php.loadbalancer.server.scheme=http"

        # URL replacement middleware (namespaced)
        - "traefik.http.middlewares.food_https_replace.replacepathregex.regex=http://([^/]+)"
        - "traefik.http.middlewares.food_https_replace.replacepathregex.replacement=https://$$1"

        # Headers middleware (namespaced)
        - "traefik.http.middlewares.food_php_headers.headers.customrequestheaders.X-Forwarded-Proto=https"

        # Chain middlewares on the router (use the namespaced router)
        - "traefik.http.routers.food_php.middlewares=food_php_headers,food_https_replace"

        # Service port (namespaced)
        - "traefik.http.services.food_php.loadbalancer.server.port=8080"

        # Optional: HTTP to HTTPS redirect router (namespaced)
        - "traefik.http.routers.food_php_http.rule=Host(`cmdondorefeitorio.mooo.com`)"
        - "traefik.http.routers.food_php_http.entrypoints=web"
        - "traefik.http.routers.food_php_http.middlewares=food_php_https_redirect"
        - "traefik.http.middlewares.food_php_https_redirect.redirectscheme.scheme=https"
volumes:
  storage_private:
  storage_sessions:
  storage_logs:
  storage_svg:
networks:
  traefik_public:
    external: true
  shared_mysql_database:
    external: true
